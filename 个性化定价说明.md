# 个性化定价机制说明

**文档日期**: 2026-01-15  
**代码版本**: 简化版（仅理论求解器）

---

## 一、核心概念

### 个性化定价 vs 统一定价

**个性化定价**（当前实现）：
```python
prices = [p_0, p_1, ..., p_{n-1}]  # 每个用户有不同的价格

# 示例
prices = [0.12, 0.00, 0.18, 0.00, 0.21, 0.15, 0.00, 0.09, 0.00, 0.14]
         └─用户0  └─用户1  └─用户2  ...
```

**统一定价**（已废弃）：
```python
# 所有用户同价（不再使用）
prices = [p, p, p, ..., p]
```

---

## 二、为什么是个性化定价？

### 2.1 经济学原理

**支撑价格公式**：
```
p_i = v_i × ΔI_i + ε

其中：
- v_i：用户i的隐私偏好（个人特征）
- ΔI_i：用户i的边际贡献（取决于S）
- ε：小扰动（1e-6）
```

**关键观察**：
```
不同用户的价格取决于：
1. 个人隐私偏好 v_i（异质性）
2. 边际信息贡献 ΔI_i（位置依赖）

⟹ p_i 必然因人而异！
```

---

### 2.2 数值示例

**参数设定**（n=5, ρ=0.6）：
```python
v = [0.3, 0.5, 0.8, 0.4, 0.9]  # 隐私偏好
S* = {0, 1, 3}                  # 理论最优分享集合
```

**边际泄露计算**：
```python
ΔI_0 = I_0(S*) - I_0(S*\{0}) = 0.32 - 0.18 = 0.14
ΔI_1 = I_1(S*) - I_1(S*\{1}) = 0.35 - 0.22 = 0.13
ΔI_3 = I_3(S*) - I_3(S*\{3}) = 0.28 - 0.15 = 0.13
```

**个性化价格**：
```python
p_0 = 0.3 × 0.14 + 1e-6 = 0.042
p_1 = 0.5 × 0.13 + 1e-6 = 0.065
p_2 = 0.0                        # 不分享，价格为0
p_3 = 0.4 × 0.13 + 1e-6 = 0.052
p_4 = 0.0                        # 不分享，价格为0
```

**观察**：
- ✅ 用户1价格最高（v中等但ΔI大）
- ✅ 用户2,4价格为0（不在最优集合中）
- ✅ 价格完全个性化

**如果用统一价格会怎样？**
```python
# 假设 p = 0.05（统一价）
p_uniform = 0.05

# 用户0：p < v_0 × ΔI_0 = 0.042
#       ⟹ 价格不够，可能不愿意分享

# 用户1：p < v_1 × ΔI_1 = 0.065
#       ⟹ 价格不够，可能不愿意分享

# 用户3：p > v_3 × ΔI_3 = 0.052
#       ⟹ 平台多付了钱（利润损失）

结论：统一价无法同时满足所有人的激励相容约束！
```

---

## 三、代码实现

### 3.1 理论求解器输出

```python
sol = solve_stackelberg_personalized(params)

# 输出结构
{
    "eq_share_set": [0, 1, 3],           # 最优分享集合
    "eq_prices": [0.042, 0.065, 0.0,     # 个性化价格向量
                  0.052, 0.0],
    "eq_profit": 0.847,                  # 平台利润
    "solver_mode": "exact"
}
```

### 3.2 用户观察到的价格

```python
# 阶段2：用户决策
for user_id in range(n):
    user_price = prices[user_id]  # 每个用户看到自己的价格
    
    # 用户i的决策
    decision = query_user_decision(
        user_id=user_id,
        price=user_price  # 个性化价格
    )
```

**用户i的信息**：
```
私有信息：
  - v_i = 0.5（自己的隐私偏好）
  - p_i = 0.065（平台给我的报价）

公共信息：
  - n = 5（总用户数）
  - ρ = 0.6（相关系数）
  - F_v ~ Uniform[0.3, 1.2]（隐私偏好分布）

不知道：
  - 其他人的 v_j
  - 其他人的 p_j  ← 不知道别人的价格！
```

---

### 3.3 Prompt设计

**关键修改**（L270-275）：

```python
# 旧版本（暗示统一价格）
f"平台给你的报价：p[{user_id}] = {price:.4f}"

# 新版本（明确个性化）
f"""
平台给你的个性化报价：p[{user_id}] = {price:.4f}
（注意：每个用户的报价可能不同，这是平台根据你的预期贡献定制的价格）
"""
```

**为什么重要？**
- 让LLM理解：不同用户有不同价格
- 避免LLM错误推断：所有人同价

---

## 四、个性化定价的优势

### 4.1 激励相容

**定义**：价格恰好让用户愿意分享

```
对于 i ∈ S*：
  u_i(分享) = p_i - v_i × I_i(S*)
            = v_i × ΔI_i + ε - v_i × I_i(S*)
            = -v_i × I_i(S*\{i}) + ε
            > u_i(不分享)  ✓

对于 j ∉ S*（p_j = 0）：
  u_j(不分享) = -v_j × I_j(S*)
              > 0 - v_j × I_j(S*∪{j})
              = u_j(分享)  ✓
```

**统一价格无法做到**：
- 价格太高 → 平台利润低
- 价格太低 → 部分用户不愿分享

---

### 4.2 利润最大化

**个性化定价**：
```
Π* = Σ I_i(S*) - Σ_{i∈S*} v_i × ΔI_i
   = 最优利润
```

**统一价格**：
```
Π_uniform = Σ I_i(S_uniform) - |S_uniform| × p
          < Π*（严格次优）
```

**证明草图**：
```
统一价格 p 必须满足：
  p ≥ max_{i∈S} {v_i × ΔI_i}  才能让所有人分享

但这意味着：
  - 对于 v_i × ΔI_i < p 的用户，平台多付了
  - 总成本 = |S| × p > Σ_{i∈S} v_i × ΔI_i

⟹ 利润更低
```

---

### 4.3 价格歧视的效率

**经济学洞察**：完全价格歧视（perfect price discrimination）实现最优配置

**在我们的模型中**：
```
个性化定价 = 完全价格歧视的一种形式
  - 平台知道每个用户的"保留价格" v_i × ΔI_i
  - 平台设定 p_i 恰好等于保留价格（加ε）
  - 榨取所有消费者剩余
```

**结果**：
- ✅ 平台利润最大
- ✅ 配置效率最高（在Stackelberg均衡意义下）
- ⚠️ 用户剩余几乎为零（恰好无差异）

---

## 五、与TMD论文的对应

### 论文中的定价机制

**Acemoglu et al. (TMD论文)**：

```
"The platform offers take-it-or-leave-it prices p_i to each user i"
                                             ^^^^
                                        个性化价格！
```

**论文命题**（Proposition）：
```
在最优 Stackelberg 均衡中：
  p_i* = v_i × [I_i(S*) - I_i(S*\{i})]
       = v_i × ΔI_i*
```

**我们的实现**：
```python
# L403: scenario_b_too_much_data.py
prices[i] = float(v[i] * marginal + epsilon)
```

✅ **完全对齐论文**

---

## 六、实验观察

### 6.1 价格分布特征

**典型输出**（n=10, ρ=0.6）：
```
个性化价格向量:
  [0.042, 0.000, 0.065, 0.000, 0.078, 0.051, 0.000, 0.039, 0.000, 0.062]

观察：
- 非零价格数：5/10（对应分享者）
- 价格范围：[0.000, 0.078]
- 价格分布：取决于 v_i 和相关性结构
```

### 6.2 价格与特征的关系

**回归分析**（理论）：
```
p_i = β_0 + β_1 × v_i + β_2 × mean_corr_i + ε

预期系数符号：
- β_1 > 0（v越大，价格越高，因为需要更多补偿）
- β_2 ?（取决于相关性如何影响ΔI_i）
```

**实证观察**：
```python
# 用户按v排序
sorted_users = sorted(range(n), key=lambda i: params.v[i])

# 分享者通常是：
# - v较低的用户（隐私成本低）
# - 但也要看ΔI_i（边际贡献）
```

---

## 七、常见问题

### Q1: 用户知道其他人的价格吗？

**A**: ❌ 不知道

```
用户i只知道：
  ✓ 自己的价格 p_i
  ✓ 隐私偏好分布 F_v
  ✗ 其他人的价格 p_j (j ≠ i)
  ✗ 其他人的隐私偏好 v_j
```

**Prompt中明确说明**：
```
注意：每个用户的报价可能不同，
但你不知道其他人获得的具体报价。
```

---

### Q2: 为什么不分享者的价格是0？

**A**: 激励相容 + 利润最大化

```
如果给不分享者非零价格：
  - 他们还是不会分享（因为 p_j < v_j × ΔI_j）
  - 平台白白损失了资源

最优策略：
  p_j = 0 for j ∉ S*
```

---

### Q3: 价格会随着S变化吗？

**A**: ✅ 会的！

```
p_i 取决于 ΔI_i = I_i(S) - I_i(S\{i})
                    └──┬──┘
                    依赖于S

例子：
  S = {0, 1} → p_0 = 0.042
  S = {0, 1, 2} → p_0' = 0.038（ΔI_0变小）
```

**但在均衡中**：
- 平台选择最优的S*
- 对应的价格p*是固定的
- 用户观察到p*并决策

---

### Q4: 个性化价格公平吗？

**A**: 取决于"公平"的定义

**效率角度**：✅ 最优配置

**分配角度**：
```
用户剩余：
  CS_i = u_i* ≈ 0（恰好无差异）

平台剩余：
  PS = Π* > 0（获得所有剩余）

⟹ 平台"剥削"用户（完全价格歧视）
```

**公平性争议**：
- 相同隐私损失，不同人价格不同
- 但这是市场机制下的最优结果

---

## 八、总结

### ✅ 当前实现（个性化定价）

**特点**：
- 每个用户有自己的价格 `p_i`
- 价格由理论求解器计算
- 完全对齐TMD论文
- 实现Stackelberg均衡

**公式**：
```
p_i = v_i × ΔI_i + ε
```

**代码**：
```python
prices = sol["eq_prices"]  # 向量，不是标量
```

---

### ❌ 已废弃（统一定价）

**问题**：
- 无法同时满足所有人的激励相容
- 利润次优
- 与TMD论文不符

**不再使用**：
```python
# 已删除
uniform_price = 0.5
prices = [uniform_price] * n
```

---

### 🎯 关键洞察

1. **个性化定价是必须的**
   - 不是可选功能
   - 是理论模型的核心

2. **价格反映异质性**
   - v_i：个人特征
   - ΔI_i：位置依赖
   - 两者共同决定p_i

3. **完全价格歧视**
   - 平台榨取所有剩余
   - 用户恰好无差异
   - 效率最优但分配不公

4. **用户不知道别人的价格**
   - 信息不完全
   - 需要基于F_v形成信念
   - 这是评估LLM的关键

---

**文档版本**: v1.0  
**作者**: AI Assistant  
**日期**: 2026-01-15

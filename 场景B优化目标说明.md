# 场景B优化目标说明

**文档日期**: 2026-01-15  
**适用代码**: 静态博弈版本（理论平台模式）

---

## 一、平台的优化目标

### 1.1 目标函数

**平台追求利润最大化**：

```
max_{p_1,...,p_n}  Π(S(p)) = α · Σ_i I_i(S(p)) - Σ_{i∈S(p)} p_i
```

其中：
- `S(p)` = 用户在价格向量p下的均衡分享集合
- `I_i(S)` = 用户i的泄露信息量（平台从推断中获得的价值）
- `α` = 平台从信息获益系数（规范化为1.0）
- `p_i` = 支付给用户i的价格

### 1.2 利润的两个组成部分

**1. 总信息价值**（收入）：
```python
platform_value = α × Σ_i I_i(S)
```
- 从**所有用户**（包括不分享者）获得信息价值
- 通过贝叶斯推断，即使用户不分享也能被推断

**2. 总支付成本**（支出）：
```python
total_payment = Σ_{i∈S} p_i
```
- 仅支付给**分享者**
- 不分享者不需要支付

**净利润**：
```python
platform_profit = platform_value - total_payment
              = Σ_i I_i(S) - Σ_{i∈S} p_i
```

### 1.3 定价策略（Stackelberg博弈）

平台是**先动者**（leader），选择价格向量p来诱导用户分享：

**步骤1：对每个可能的分享集合S**
- 计算使S成为均衡的**最小支撑价格**：
  ```python
  p_i = v_i × [I_i(分享|S) - I_i(不分享|S\{i})] + ε
      = v_i × ΔI_i + ε
  ```
  - `ΔI_i` = 边际泄露（相对于不分享）
  - `ε` = 小扰动（打破无差异，确保分享）

**步骤2：选择利润最优的集合**
```python
S* = argmax_{S⊆{1,...,n}} [Σ_i I_i(S) - Σ_{i∈S} p_i^S]
```

**代码实现**：
- 小规模（n≤22）：枚举所有2^n个集合 → `solve_stackelberg_personalized()` L469-495
- 大规模：局部搜索 + 多次重启 → L497-544

---

## 二、用户的优化目标

### 2.1 目标函数

**用户i追求效用最大化**：

```
max_{a_i∈{0,1}}  E_{a_{-i}}[u_i(a_i, a_{-i})]
```

其中 `a_i = 1` 表示分享，`a_i = 0` 表示不分享。

### 2.2 效用函数

**分享时的效用**：
```python
u_i(分享) = p_i - v_i × I_i(S)
```

**不分享时的效用**：
```python
u_i(不分享) = 0 - v_i × I_i(S\{i})
            = -v_i × I_i(S\{i})
```

**关键点**：
1. ✅ **不分享也会泄露**：即使a_i=0，只要其他人分享，平台也能推断用户i
2. ✅ **分享获得补偿**：p_i是对隐私损失的货币补偿
3. ✅ **成本是边际泄露**：分享的真正成本 = `v_i × [I_i(S) - I_i(S\{i})]`

### 2.3 决策规则

用户i选择分享当且仅当：

```
E[u_i(分享)] > E[u_i(不分享)]
```

展开：
```
p_i - v_i × E[I_i(S)] > -v_i × E[I_i(S\{i})]

⟺ p_i > v_i × E[I_i(S) - I_i(S\{i})]

⟺ p_i > v_i × E[ΔI_i]
```

**解释**：报价必须覆盖**期望边际隐私损失**。

### 2.4 理性预期

因为是**同时博弈**，用户i不知道其他人的决策a_{-i}，需要形成**信念**：

**基于先验F_v推测**：
- v较低的用户更可能分享（隐私成本低）
- v较高的用户更不可能分享（隐私成本高）
- 用自己的v相对位置 + 次模性判断分享率

**Prompt中的引导**（L315-328）：
```
1. 基于分布推测其他人的行为
2. 计算期望效用
3. 理解次模性（分享多→边际价值低）
4. 做出最佳反应
```

**输出要求**：
```json
{
  "share": 1,
  "belief_share_rate": 0.45,  // 显式捕捉信念
  "reason": "..."
}
```

---

## 三、目标函数的数学对应

### 3.1 泄露信息量（核心概念）

**定义**（基于贝叶斯后验方差）：
```
I_i(S) = Var(X_i) - Var(X_i | S)
       = σ_i² - σ_i²(S)
```

**计算**（高斯条件分布）：
```python
Σ_post = Σ - Σ H^T (H Σ H^T + σ²I)^{-1} H Σ
I_i(S) = Σ[i,i] - Σ_post[i,i]
```

**性质**：
1. **单调性**：S₁ ⊆ S₂ ⟹ I_i(S₁) ≤ I_i(S₂)
   - 分享的人越多，推断越准确，泄露越大
   
2. **次模性**：ΔI_i(j | S₁) ≥ ΔI_i(j | S₂)  当 S₁ ⊆ S₂
   - 边际信息价值递减
   - 已有很多人分享时，新增一人的边际贡献小

### 3.2 推断外部性

**关键机制**：
```
∂I_i(S) / ∂a_j ≠ 0  （即使 i ≠ j）
```

- 用户j的决策影响用户i的泄露
- 即使i不分享，j分享也会泄露i的信息（通过相关性）

**在效用中的体现**（L302-309）：
```
u_i = p_i × share_i - v_i × I_i(share_i, share_{-i})
                                         ^^^^^^^^
                                     外部性来源
```

---

## 四、均衡概念

### 4.1 Stackelberg均衡（当前实现）

**定义**：两阶段博弈的子博弈完美纳什均衡

**阶段1（平台先动）**：
```
max_{p∈ℝ^n_+} Π(p) = Σ_i I_i(S*(p)) - Σ_{i∈S*(p)} p_i
```
其中 S*(p) 是阶段2用户的均衡响应。

**阶段2（用户后动）**：
给定价格p，每个用户i选择：
```
a_i*(p) ∈ argmax_{a_i∈{0,1}} E[u_i(a_i, a_{-i}*(p))]
```

**均衡性质**：
1. **激励相容**：用户i选择分享的充要条件是 `p_i ≥ v_i × ΔI_i`
2. **平台最优**：平台选择的S*最大化利润
3. **次优性**：S* 通常不等于社会最优S_fb（过度分享）

### 4.2 社会最优（First Best）

**社会规划者最大化总福利**：
```
max_{S⊆{1,...,n}} W(S) = Σ_i I_i(S) - Σ_i v_i × I_i(S)
                        = Σ_i (1 - v_i) × I_i(S)
```

**解释**：
- 价格p是转移支付，在社会福利中抵消
- 只保留信息价值（收益）- 隐私成本（损失）

**过度分享条件**（TMD核心结果）：
```
|S*| > |S_fb|  当相关性强、外部性显著时
```

---

## 五、代码中的关键位置

### 5.1 平台优化

| 功能 | 函数/位置 | 说明 |
|------|----------|------|
| 理论求解器 | `solve_stackelberg_personalized()` L447 | 枚举/局部搜索找最优S |
| 利润计算 | `_profit_for_set_under_supporting_prices()` L407 | 给定S计算利润 |
| 支撑价格 | `_supporting_prices_for_set()` L385 | 计算p_i = v_i×ΔI_i+ε |
| 平台定价 | `evaluate_scenario_b.py` L551-558 | 调用求解器获取价格 |

### 5.2 用户优化

| 功能 | 函数/位置 | 说明 |
|------|----------|------|
| 效用函数 | Prompt L302-304 | 显式说明u_i公式 |
| 决策规则 | Prompt L315-328 | 理性预期框架 |
| 信念形成 | `query_user_decision()` L430+ | LLM输出belief_share_rate |
| 效用计算 | `solve_for_S_with_prices()` L234+ | 给定S和p计算实际效用 |

### 5.3 泄露计算

| 功能 | 函数/位置 | 说明 |
|------|----------|------|
| 后验协方差 | `compute_posterior_covariance()` L87 | 高斯条件分布 |
| 泄露向量 | `calculate_leakage()` L192 | I_i(S) for all i |
| 边际泄露 | `solve_for_S()` L164-174 | ΔI_i = I_i(S) - I_i(S\{i}) |

---

## 六、与TMD论文的对应

### 6.1 论文公式到代码的映射

| 论文符号 | 代码变量 | 说明 |
|---------|---------|------|
| S | `set(llm_share_set)` | 分享集合 |
| I_i(S) | `leakage[i]` | 泄露信息量 |
| v_i | `params.v[i]` | 隐私偏好 |
| p_i | `prices[i]` | 报价 |
| Π(S) | `platform_profit` | 平台利润 |
| W(S) | `welfare` | 社会福利 |
| ρ | `params.rho` | 相关系数 |

### 6.2 TMD的关键机制

**1. 推断外部性**（Inference Externality）
- ✅ 代码实现：`compute_posterior_covariance()` 捕捉相关性
- ✅ Prompt说明：L295-300 "即使不分享也会泄露"

**2. 次模性**（Submodularity）
- ✅ 数学性质：由后验方差的凸性保证
- ✅ Prompt说明：L325 "边际信息价值递减"

**3. 过度分享**（Over-sharing）
- ✅ 评估指标：`jaccard_similarity(S*, S_fb)` < 1
- ✅ 标签：`over_sharing = 1 if |S*| > |S_fb|`

---

## 七、实验中的观测指标

### 7.1 平台表现

```python
"platform": {
    "mode": "theory_solver",
    "prices": [...],                    # 个性化价格向量
    "theory_share_set": [0, 2, 5],     # 理论预测的分享集合
    "solver_mode": "exact"              # 求解方法
}
```

### 7.2 用户表现

```python
"users": {
    "decisions": {0: 1, 1: 0, ...},    # 实际决策
    "beliefs": {0: 0.45, 1: 0.38, ...}, # 信念分享率
    "v_values": [0.35, 0.87, ...]       # 隐私偏好
}
```

### 7.3 均衡质量

```python
"equilibrium_quality": {
    "share_set_similarity": 0.75,       # Jaccard(LLM, Theory)
    "welfare_mae": 0.023,               # |W_LLM - W_Theory|
    "profit_mae": 0.015                 # |Π_LLM - Π_Theory|
}
```

### 7.4 信念一致性

```python
"belief_consistency": {
    "actual_share_rate": 0.50,          # 实际分享率
    "mean_belief": 0.48,                # 平均信念
    "mean_belief_error": 0.12           # 平均误差
}
```

---

## 八、总结对比表

| 维度 | 平台 | 用户 |
|------|------|------|
| **目标** | 利润最大化 | 效用最大化 |
| **决策变量** | 价格向量 p | 分享决策 a_i ∈ {0,1} |
| **收益** | Σ I_i(S) | p_i（仅分享时） |
| **成本** | Σ_{i∈S} p_i | v_i × I_i(S) |
| **博弈角色** | Leader（先动者） | Follower（后动者） |
| **信息** | 知道F_v，不知道v_i | 知道v_i，不知道v_{-i} |
| **均衡概念** | Stackelberg | Bayes-Nash |
| **外部性** | 受益于外部性（更多信息） | 受损于外部性（连带泄露） |
| **社会性质** | 可能诱导过度分享 | 个体理性但社会次优 |

---

**关键洞察**：

1. 平台和用户的目标**不一致**（平台最大化利润 vs 用户最大化效用）
2. 外部性导致市场**失灵**（均衡不等于社会最优）
3. 次模性使得平台**压低价格**（边际价值递减）
4. 推断外部性是**核心机制**（不分享也泄露）

---

**文档版本**: v1.0  
**最后更新**: 2026-01-15  
**维护者**: AI Assistant
